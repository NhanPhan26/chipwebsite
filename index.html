<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MQTT 3 Toggle — Simple</title>
  <style>
    :root{
      --bg:#041021; --card:#071827; --muted:#9aa4b2; --on:#10b981; --off:#cbd5e1;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#03121a,#04162a); color:#e6eef6;
      display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .card{
      width:420px; max-width:95vw; border-radius:12px; padding:20px 18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      box-shadow: 0 10px 40px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.03);
      text-align:center;
    }
    h1{margin:0;font-size:18px}
    p.lead{margin:8px 0 18px;color:var(--muted);font-size:13px}
    .group{display:flex;flex-direction:column;gap:16px;align-items:center}
    .row{display:flex;align-items:center;gap:14px;width:100%;justify-content:space-between}
    .label { font-weight:700; font-size:15px; color: #e6eef6 }
    .small { font-size:12px; color:var(--muted) }

    /* Toggle */
    .switch {
      --w:84px; --h:44px;
      width:var(--w); height:var(--h); border-radius:26px; position:relative;
      background:rgba(255,255,255,0.04); padding:5px; box-sizing:border-box;
      display:inline-block; transition:background .14s ease, opacity .14s;
      cursor:pointer;
    }
    .switch[aria-disabled="true"]{ opacity:0.45; cursor:not-allowed; }
    .switch[data-on="true"]{ background: linear-gradient(90deg, rgba(16,185,129,0.18), rgba(6,182,212,0.08)); }
    .knob { width:34px;height:34px;border-radius:50%;background:white;transform:translateX(0); transition: transform .14s cubic-bezier(.2,.9,.3,1) }
    .switch[data-on="true"] .knob { transform: translateX(40px); }
    .status { margin-top:12px; font-size:13px; color:var(--muted) }
    .stateText { font-weight:700; font-size:14px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>MQTT • 3 Switch</h1>
    <p class="lead">3 công tắc (turn_light_1 / turn_light_2 / turn_light_3). Bị khoá đến khi kết nối.</p>

    <div class="group">
      <!-- Switch 1 -->
      <div class="row">
        <div style="text-align:left">
          <div class="label">Đèn 1</div>
          <div class="small">Topic: <code>turn_light_1</code></div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:center">
          <div id="toggle1" class="switch" role="button" tabindex="0" data-on="false" aria-pressed="false" aria-disabled="true">
            <div class="knob"></div>
          </div>
          <div class="stateText" id="state1">TẮT</div>
        </div>
      </div>

      <!-- Switch 2 -->
      <div class="row">
        <div style="text-align:left">
          <div class="label">Đèn 2</div>
          <div class="small">Topic: <code>turn_light_2</code></div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:center">
          <div id="toggle2" class="switch" role="button" tabindex="0" data-on="false" aria-pressed="false" aria-disabled="true">
            <div class="knob"></div>
          </div>
          <div class="stateText" id="state2">TẮT</div>
        </div>
      </div>

      <!-- Switch 3 -->
      <div class="row">
        <div style="text-align:left">
          <div class="label">Đèn 3</div>
          <div class="small">Topic: <code>turn_light_3</code></div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:center">
          <div id="toggle3" class="switch" role="button" tabindex="0" data-on="false" aria-pressed="false" aria-disabled="true">
            <div class="knob"></div>
          </div>
          <div class="stateText" id="state3">TẮT</div>
        </div>
      </div>
    </div>

    <div class="status" id="connStatus">Trạng thái kết nối: <strong>Chưa kết nối</strong></div>
  </div>

  <!-- mqtt.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    // ---------- CONFIG (pre-filled) ----------
    const BROKER_URL = 'wss://5ddabd57e04648cf9b89ed05225e9ddc.s1.eu.hivemq.cloud:8884/mqtt';
    const USERNAME = 'phannhan2612oz';
    const PASSWORD = 'Thanhnhan003';
    const TOPICS = ['turn_light_1', 'turn_light_2', 'turn_light_3'];
    const QOS = 0;

    // ---------- UI refs ----------
    const toggleEls = [
      document.getElementById('toggle1'),
      document.getElementById('toggle2'),
      document.getElementById('toggle3')
    ];
    const stateEls = [
      document.getElementById('state1'),
      document.getElementById('state2'),
      document.getElementById('state3')
    ];
    const connStatusEl = document.getElementById('connStatus');

    // ---------- State ----------
    let client = null;
    let connected = false;
    const deviceStates = ['OFF','OFF','OFF']; // default OFF (Option A)

    // Helpers
    function setToggleEnabled(index, enabled) {
      toggleEls[index].setAttribute('aria-disabled', enabled ? 'false' : 'true');
    }
    function setAllTogglesEnabled(enabled) {
      toggleEls.forEach((el) => el.setAttribute('aria-disabled', enabled ? 'false' : 'true'));
    }
    function setConnectionText(text, ok) {
      connStatusEl.innerHTML = 'Trạng thái kết nối: <strong>' + text + '</strong>';
      setAllTogglesEnabled(Boolean(ok));
    }
    function setDeviceStateUI(index, state) {
      const el = toggleEls[index];
      const txt = state === 'ON' ? 'BẬT' : state === 'OFF' ? 'TẮT' : 'Unknown';
      el.setAttribute('data-on', state === 'ON' ? 'true' : 'false');
      el.setAttribute('aria-pressed', state === 'ON' ? 'true' : 'false');
      stateEls[index].innerText = txt;
      stateEls[index].style.color = state === 'ON' ? '#9be6c7' : '#cbd5e1';
    }

    // ---------- MQTT ----------
    function createClientAndConnect() {
      console.log('Connecting to', BROKER_URL);
      try {
        client = mqtt.connect(BROKER_URL, {
          clientId: 'web_3toggle_' + Math.floor(Math.random()*10000),
          username: USERNAME,
          password: PASSWORD,
          reconnectPeriod: 3000,
          connectTimeout: 30 * 1000,
          keepalive: 20,
          clean: true
        });
      } catch (e) {
        console.error('Create client error', e);
        setConnectionText('Lỗi tạo client', false);
        return;
      }

      client.on('connect', function () {
        console.log('Connected');
        connected = true;
        setConnectionText('Đã kết nối', true);
        // subscribe all topics
        TOPICS.forEach((t) => {
          client.subscribe(t, { qos: QOS }, (err) => {
            if (err) console.warn('Subscribe error', t, err);
            else console.log('Subscribed', t);
          });
        });
      });

      client.on('reconnect', function () {
        console.log('Reconnecting...');
        connected = false;
        setConnectionText('Đang kết nối lại...', false);
      });

      client.on('close', function () {
        console.log('Closed');
        connected = false;
        setConnectionText('Đã ngắt', false);
      });

      client.on('offline', function () {
        console.log('Offline');
        connected = false;
        setConnectionText('Offline', false);
      });

      client.on('error', function (err) {
        console.error('MQTT error', err);
        // keep reconnecting
      });

      client.on('message', function (topic, payload) {
        const msg = payload.toString();
        console.log('Received', topic, msg);
        // map topic to index
        const idx = TOPICS.indexOf(topic);
        if (idx >= 0) {
          if (msg === 'ON' || msg === 'OFF') {
            deviceStates[idx] = msg;
            setDeviceStateUI(idx, msg);
          } else {
            // unknown payload: ignore or set to unknown
            setDeviceStateUI(idx, null);
          }
        }
      });
    }

    function publishState(index, state) {
      if (!client || !connected) {
        console.warn('Not connected, cannot publish');
        return;
      }
      const topic = TOPICS[index];
      client.publish(topic, String(state), { qos: QOS }, (err) => {
        if (err) console.warn('Publish error', err);
        else console.log('Published', topic, state);
      });
    }

    // ---------- UI interactions ----------
    function toggleAction(index) {
      const disabled = toggleEls[index].getAttribute('aria-disabled') === 'true';
      if (disabled) return;
      const currentlyOn = toggleEls[index].getAttribute('data-on') === 'true';
      const next = currentlyOn ? 'OFF' : 'ON';
      // optimistic update
      deviceStates[index] = next;
      setDeviceStateUI(index, next);
      publishState(index, next);
    }

    // attach listeners
    toggleEls.forEach((el, idx) => {
      el.addEventListener('click', () => toggleAction(idx));
      el.addEventListener('keydown', (ev) => { if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); toggleAction(idx); }});
    });

    // ---------- Init ----------
    // default UI = OFF (Option A)
    deviceStates.forEach((s, i) => setDeviceStateUI(i, s));
    setAllTogglesEnabled(false);
    setConnectionText('Chưa kết nối', false);

    // auto connect shortly after load
    setTimeout(() => createClientAndConnect(), 300);

    // clean disconnect on unload
    window.addEventListener('beforeunload', () => { try { if (client && client.end) client.end(true); } catch(e) {} });

  </script>
</body>
</html>
